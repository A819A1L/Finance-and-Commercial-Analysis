CREATE PROCEDURE [dbo].[UpdateWIPDataFromTharstern]
	
AS
BEGIN	
    SET NOCOUNT ON;

		INSERT INTO [database2].[dbo].[WIP_thardata] 
				(
                    [JobNo], [JobID], [InvoiceID], [EstimateNo], [InvoiceCustomerName], [QuantityOrdered], [QuantityProduced], 
                    [QuantityDelivered], [PriceQuoted], [MaterialWIP], [LabourWIP], [OutworkCarriageWIP], [SalesLead], [Team],
                    [KeyAccount], [Estimator], [JobDesc], [ProductType], [JobDate], [JobCreated], [RequiredDate], [ReportCreated],
                    [EstPrintMatCost], [EstOtherMatCost], [EstOutworkCost], [EstCarriageCost], [EstPrintingLabCost], 
                    [EstPrintingOHCost], [TotalEstPrintingCost], [EstFinishingLabCost], [EstFinishingOHCost], [TotalEstFinishingCost]
                )

        (
            SELECT mjd.JobNo,
                mjd.ID as JobID,
                mjd.InvoiceID,
                mjd.EstimateHeaderRef as EstimateNo,
                mjd.InvoiceCustomerName,
                mjd.QuantityOrdered,
                mjd.QuantityProduced,
                mjd.QuantityDelivered,
                med.TotalTotal as PriceQuoted,
                (SELECT sum(jt.WIPValue)
                    FROM database1.dbo.JobTotals jt
                    WHERE mjd.JobNo = jt.JobNo
                    AND jt.TotalType IN (1,2,3)
                    AND jt.WIPValue <> 0
                    ) as MaterialWIP, 
                (SELECT sum(jt.WIPValue)
                    FROM database1.dbo.JobTotals jt
                    WHERE mjd.JobNo = jt.JobNo
                    AND jt.TotalType IN (6,7,8)
                    AND jt.WIPValue <> 0
                    ) as LabourWIP,
                (SELECT sum(jt.WIPValue)
                    FROM database1.dbo.JobTotals jt
                    WHERE mjd.JobNo = jt.JobNo
                    AND jt.TotalType IN (4,5)
                    AND jt.WIPValue <> 0
                    ) as OutworkCarriageWIP,
                mjd.Ref1 as SalesLead,
                mjd.Ref2 as Team,
                mjd.Ref3 as KeyAccount,
                mjd.Estimator,
                mjd.JobDesc,
                mjd.JobTypeDesc as ProductType,
                mjd.Datedb as JobDate,
                mjd.CreateDateTime as JobCreated,
                mjd.RequiredTime as RequiredDate,
                GETDATE() as ReportCreated,
                med.PaperSubTot as EstPrintMatCost,
                med.OtherMatSubTotal as EstOtherMatCost,
                med.OutworkSubtot as EstOutworkCost,
                med.CarriageSubTotal as EstCarriageCost,
                med.PrintingLabSubTotal as EstPrintingLabCost,
                med.PrintingOHSubTotal as EstPrintingOHCost,
                med.PrintingSubTotal as TotalEstPrintingCost,
                med.FinishingLabSubTotal as EstFinishingLabCost,
                med.FinishingOHSubTotal as EstFinishingOHCost,
                med.FinishingSubTotal as TotalEstFinishingCost

            FROM database1.dbo.MainJobDetails mjd
            JOIN database1.dbo.MainEstimateDetails med ON mjd.JobNo = med.jobcreated
            WHERE mjd.JobCompleted = 0
            AND mjd.JobCancelled = 0
            AND mjd.InvoiceCompleted = 0
            AND mjd.IsInvoiced = 0
            AND mjd.JobNo NOT IN(338733.01, 338733.02, 338733.03, 338733.04, 338733.05, 338733.06, 338733.07, 338733.08,
                338733.09, 338733.10, 338733.11, 338733.12, 338733.13, 338733.14, 338733.15, 338733.16, 338733.17,
                338733.18, 338733.19, 338733.20)
        )
    
    END
GO
